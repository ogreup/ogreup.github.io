<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>关于API命名 | Ogreup's TechNote</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">关于API命名</h1><a id="logo" href="/.">Ogreup's TechNote</a><p class="description">一个软件攻城狮的所做所想，以及踩坑经验分享</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">关于API命名</h1><div class="post-meta">Jan 20, 2017</div><a data-disqus-identifier="2017/01/20/关于API命名/" href="/2017/01/20/关于API命名/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>好的API命名是可以根据完成的功能猜出来的。<br><a id="more"></a></p>
<p>写完这个题目，想起大学里刚开始学习编程时，同宿舍一哥们儿已经编程小牛一枚了。我问他，你怎么知道实现某个操作（比如获得CString对象的长度，获取系统时间，等等）需要调用哪个函数？答曰：靠猜啊，还有MSDN。于是我也学会了这种方法：需要实现什么功能，先猜一猜可能的名称会是什么，然后在MSDN的索引里边去找，屡试不爽。后来随着接触的东西慢慢增多，也会发现不同的系统/库在命名方面会有不同的习惯（convention)或者风格（flavor），但猜出来的东西基本八九不离十，就算没有直接命中也能发现非常相关的信息。</p>
<p>好的API命名应该是告诉用户这个函数要干什么，不多不少。命名反映了设计者的基本素养，就算从命名大致推断设计者的水平可能也不为过。花了好一段时间解决了OSG中世界坐标向屏幕坐标的转换问题，我感觉有点被（可能不好）的API命名给坑了。</p>
<p>项目指定使用OSG进行仿真场景开发，并且需要得到目标（OSG场景中的某个Node）的屏幕坐标位置，作为其他一些操作的输入条件。刚开始时倒是在网上找到了一些代码片段，但是算出来的结果都明显不对。由于时间比较紧张、对OSG也不熟悉，于是采取了其它方法实现了这个功能，不足之处是计算结果有些偏差；好在进行固定值修正后也能满足使用要求。</p>
<p>这两天有些空闲时间，于是又开始捣鼓这一问题的精确解析方法。其实过程说起来也简单，就是根据节点的世界坐标，进行视图（View）、投影（Projection）和窗口（Window）矩阵的转换，然后就完事儿了；这些转换矩阵OSG中都提供了明确的函数调用，于是重要的问题便是得到节点的世界坐标。OSG中场景采用树型结构进行组织，节点可能存在父节点、祖父节点。。。，节点的坐标又有局部和世界之分。根据我的理解，局部坐标就是节点相对其父节点的坐标，世界坐标就是节点在场景中的绝对坐标，也就是相当于场景根节点的坐标。为了计算世界坐标，OSG好心地提供了osg::computeLocalToWorld这样一个全局函数，网上找到的用法类似这样：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">worldPos = localPos * osg::computeLocalToWorld(<span class="keyword">node</span><span class="title">-&gt;getParentalNodePaths</span>()[<span class="number">0</span>]);</div></pre></td></tr></table></figure>
<p>从字面上看，getParentalNodePaths得到一系列的路径，每条路径由父节点至场景根的多个节点组成；于是computeLocalToWorld得到局部坐标到世界坐标的转换矩阵；再去乘localPos，得到worldPos。看起来合情合理。但实际执行结果却是另一回事，总是得到显然不合理的结果。</p>
<p>为了搞清楚是怎么回事，我写了一个简单的测试程序，搭建了一个简单的场景，试图一步一步验证计算结果是否与预想的情况一致。结果发现世界坐标的计算就出错了：node直接插入场景根并设置其坐标为(10, 0, 0)，这样对node来说局部坐标和世界坐标都应保持(10, 0, 0)不变，而通过计算却得到(20, 0, 0)。再检查getParentalNodePath()[0]，发现返回的结果是这样:Camera&lt;-SceneRoot&lt;-node：不仅包括一个摄像机节点，而且node自身也包括在内。这些都与预想的情况不一样。会不会由于getParentalNodePaths的结果包括了调用者本身，使得计算时出现了重复呢？修改并验证了一下，果然（居然就）得到了正确的结果。进一步查看了OSG3.4源码，也发现了类似的计算过程（搜索prunedNodePath)。最终经过多次验证，世界坐标的计算方法是这样：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// osg::PositionAttitudeTransform *<span class="keyword">node</span> <span class="title">= ...</span></div><div class="line"><span class="title">osg</span>::NodePath nodePath = <span class="keyword">node</span><span class="title">-&gt;getParentalNodePaths</span>()[<span class="number">0</span>];</div><div class="line">osg::NodePath prunedNodePath(nodePath.begin(), nodePath.end() - <span class="number">1</span>);</div><div class="line">osg::Vec3d worldPos = <span class="keyword">node</span><span class="title">-&gt;getPosition</span>() * osg::computeLocalToWorld(prunedNodePath)</div><div class="line">或者：</div><div class="line">osg::NodePath nodePath = <span class="keyword">node</span><span class="title">-&gt;getParentalNodePaths</span>()[<span class="number">0</span>];</div><div class="line">osg::Vec3d worldPos = osg::Vec3d(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) * osg::computeLocalToWorld(nodePath)</div></pre></td></tr></table></figure>
<p>以上两种方式，不管是哪一种，在我看来都比较别扭，不像是可以正确工作的代码，因为computeLocalToWorld和getParentalNodePaths其字面上带给人的信息和在代码中的实际作用不太吻合。有点被“不好的API命名”给坑了。（不知我的理解是否正确）</p>
<p>通过这次解决问题得到的一些经验：</p>
<ol>
<li>对于不知道的东西，如果通过搜索的方式获得结果，最好能够理解别人提供的解决方案。官方的源代码是第一手资料，看源码中那些你不熟悉的API是怎么用的，作者的用法是API设计意图最好的体现；</li>
<li>出现问题，首先在尽可能简化的情况下进行逐步检验，看看每一步的结果是否符合预期；这可能比在网上盲目搜索并寄希望得到专家解答更高效；</li>
<li>需要对代码进行说明时，可以采用assert的方式表述你认为的结论。</li>
</ol>
</div><div class="tags"><a href="/tags/折腾/">折腾</a><a href="/tags/software/">software</a><a href="/tags/osg/">osg</a></div><div class="post-nav"><a href="/2017/04/04/第一个Android应用/" class="pre">第一个Android应用</a><a href="/2016/05/20/关于tinyxml的“奇怪”问题/" class="next">关于tinyxml的“奇怪”问题</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'ogreup';
var disqus_identifier = '2017/01/20/关于API命名/';
var disqus_title = '关于API命名';
var disqus_url = 'https://ogreup.github.io/2017/01/20/关于API命名/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/next/config.json',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//ogreup.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://ogreup.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/折腾/" style="font-size: 15px;">折腾</a> <a href="/tags/osg/" style="font-size: 15px;">osg</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/mpl/" style="font-size: 15px;">mpl</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/software/" style="font-size: 15px;">software</a> <a href="/tags/ss/" style="font-size: 15px;">ss</a> <a href="/tags/踩坑/" style="font-size: 15px;">踩坑</a> <a href="/tags/qt/" style="font-size: 15px;">qt</a> <a href="/tags/programming/" style="font-size: 15px;">programming</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/android/" style="font-size: 15px;">android</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/09/09/关于git在windows平台的core-autocrlf参数/">关于Git在Windows平台的core.autocrlf参数</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/06/git无法使用socks5代理/">git无法使用socks5代理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/20/thinkpad-t460安装windows7/">Thinkpad T460安装Windows7</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/07/numpy中loadtxt-genfromtxt的一些不一致性/">numpy中loadtxt/genfromtxt的一些不一致性</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/02/Windows7配置Qt5-7-1开发环境/">Windows7配置Qt5.7.1开发环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/16/Fedora25安装YouCompleteMe/">Fedora25安装YouCompleteMe</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/04/第一个Android应用/">第一个Android应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/20/关于API命名/">关于API命名</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/20/关于tinyxml的“奇怪”问题/">关于tinyxml的“奇怪”问题</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> Recent Comments</i></div><script type="text/javascript" src="//ogreup.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Ogreup's TechNote.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>